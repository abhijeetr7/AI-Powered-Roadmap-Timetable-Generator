<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Roadmap & Timetable Generator</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
            color: #333;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 2rem;
        }
        .card {
            background-color: #fff;
            border-radius: 1rem;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
            padding: 2rem;
            margin-bottom: 2rem;
        }
        input[type="text"],
        input[type="date"],
        input[type="number"],
        select,
        textarea {
            border: 1px solid #d1d5db;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            width: 100%;
            font-size: 1rem;
            transition: border-color 0.2s;
        }
        input[type="text"]:focus,
        input[type="date"]:focus,
        input[type="number"]:focus,
        select:focus,
        textarea:focus {
            outline: none;
            border-color: #4f46e5; /* Indigo 600 */
            box-shadow: 0 0 0 3px rgba(99, 102, 241, 0.2); /* Indigo 500 with opacity */
        }
        button {
            background-color: #6366f1; /* Indigo 500 */
            color: #fff;
            padding: 0.75rem 1.5rem;
            border-radius: 0.5rem;
            font-weight: 600;
            transition: background-color 0.2s, transform 0.1s;
            cursor: pointer;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        button:hover {
            background-color: #4f46e5; /* Indigo 600 */
            transform: translateY(-1px);
        }
        button:active {
            transform: translateY(0);
        }
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
            flex-direction: column;
        }
        .spinner {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #6366f1;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        .modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1001;
        }
        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.2);
            max-width: 400px;
            text-align: center;
        }
        .roadmap-item {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background-color: #f9fafb;
        }
        .timetable-day {
            border: 1px solid #e5e7eb;
            border-radius: 0.75rem;
            padding: 1rem;
            margin-bottom: 0.75rem;
            background-color: #f9fafb;
        }
        .difficulty-easy { background-color: #d1fae5; color: #065f46; } /* Green 100 / Green 800 */
        .difficulty-medium { background-color: #fef3c7; color: #92400e; } /* Yellow 100 / Yellow 800 */
        .difficulty-hard { background-color: #fee2e2; color: #991b1b; } /* Red 100 / Red 800 */

        /* Drag and Drop styles */
        .dragging {
            opacity: 0.5;
            border: 2px dashed #6366f1;
        }
        .drop-target {
            background-color: #e0e7ff; /* Indigo 100 */
            border: 2px dashed #6366f1;
        }
    </style>
</head>
<body class="bg-gray-100 text-gray-800">
    <div id="loading-overlay" class="loading-overlay hidden">
        <div class="spinner"></div>
        <p class="mt-4 text-lg font-semibold text-indigo-600">Generating your personalized plan...</p>
    </div>

    <div id="custom-modal" class="modal hidden">
        <div class="modal-content">
            <h3 id="modal-title" class="text-xl font-bold mb-4"></h3>
            <p id="modal-message" class="mb-6"></p>
            <button id="modal-close-button" class="px-6 py-2 bg-indigo-500 text-white rounded-lg hover:bg-indigo-600">Close</button>
        </div>
    </div>

    <div class="container py-8">
        <h1 class="text-4xl font-extrabold text-center text-indigo-700 mb-10">AI-Powered Roadmap & Timetable Generator</h1>

        <div class="card">
            <h2 class="text-2xl font-bold text-indigo-600 mb-6">Your Learning Goal</h2>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                <div>
                    <label for="topic" class="block text-sm font-medium text-gray-700 mb-2">Learning Topic/Goal</label>
                    <input type="text" id="topic" placeholder="e.g., Java backend development" class="focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="deadline" class="block text-sm font-medium text-gray-700 mb-2">Deadline</label>
                    <input type="date" id="deadline" class="focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="hoursPerDay" class="block text-sm font-medium text-gray-700 mb-2">Hours per Day</label>
                    <input type="number" id="hoursPerDay" min="1" max="24" value="2" class="focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div>
                    <label for="skillLevel" class="block text-sm font-medium text-gray-700 mb-2">Skill Level</label>
                    <select id="skillLevel" class="focus:ring-indigo-500 focus:border-indigo-500">
                        <option value="Beginner">Beginner</option>
                        <option value="Intermediate">Intermediate</option>
                        <option value="Advanced">Advanced</option>
                    </select>
                </div>
                <div class="md:col-span-2 flex items-center">
                    <input type="checkbox" id="excludeWeekends" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded">
                    <label for="excludeWeekends" class="ml-2 block text-sm font-medium text-gray-700">Exclude Weekends from Timetable</label>
                </div>
            </div>
            <div class="mt-8 flex flex-col sm:flex-row justify-center space-y-4 sm:space-y-0 sm:space-x-4">
                <button id="generate-btn" class="flex items-center justify-center space-x-2">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m6.364 16.364l-.707-.707M12 21v-1m-6.364-1.636l-.707.707M18 10a8 8 0 11-16 0 8 8 0 0116 0z"></path></svg>
                    <span>Generate Roadmap & Timetable</span>
                </button>
                <button id="enable-notifications-btn" class="flex items-center justify-center space-x-2 bg-purple-500 hover:bg-purple-600">
                    <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 17h5l-1.405-1.405A2.032 2.032 0 0118 14.158V11a6.002 6.002 0 00-4-5.659V5a2 2 0 10-4 0v.341C7.67 6.165 6 8.388 6 11v3.159c0 .538-.214 1.055-.595 1.436L4 17h5m6 0v1a3 3 0 11-6 0v-1m6 0H9"></path></svg>
                    <span>Enable Notifications</span>
                </button>
            </div>
            <p class="text-center text-sm text-gray-500 mt-4">Your User ID: <span id="user-id" class="font-mono text-indigo-600">Loading...</span></p>
        </div>

        <div class="card" id="roadmap-section" style="display: none;">
            <h2 class="text-2xl font-bold text-indigo-600 mb-6">Your Personalized Roadmap</h2>
            <div class="mb-4">
                <h3 class="text-lg font-semibold text-gray-700 mb-2">Overall Progress:</h3>
                <div class="w-full bg-gray-200 rounded-full h-4">
                    <div id="progress-bar" class="bg-indigo-500 h-4 rounded-full transition-all duration-500" style="width: 0%;"></div>
                </div>
                <p id="progress-text" class="text-right text-sm text-gray-600 mt-1">0% completed</p>
            </div>
            <div id="roadmap-output">
                <!-- Roadmap items will be dynamically inserted here -->
            </div>
        </div>

        <div class="card" id="timetable-section" style="display: none;">
            <h2 class="text-2xl font-bold text-indigo-600 mb-6">Your Study Timetable</h2>
            <div id="timetable-output">
                <!-- Timetable days will be dynamically inserted here -->
            </div>
        </div>
    </div>

    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Global variables for Firebase and data
        let app;
        let db;
        let auth;
        let userId = 'anonymous'; // Default to anonymous
        let isAuthReady = false; // Flag to indicate if auth state is ready
        let currentRoadmapData = [];
        let currentTimetableData = {};

        // Custom Modal Functionality
        function showModal(title, message) {
            document.getElementById('modal-title').innerText = title;
            document.getElementById('modal-message').innerText = message;
            document.getElementById('custom-modal').classList.remove('hidden');
        }

        document.getElementById('modal-close-button').addEventListener('click', () => {
            document.getElementById('custom-modal').classList.add('hidden');
        });

        // Initialize Firebase
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {};

        if (Object.keys(firebaseConfig).length > 0) {
            app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);

            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    document.getElementById('user-id').innerText = userId;
                } else {
                    // Sign in anonymously if no user is found
                    try {
                        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
                        if (initialAuthToken) {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } else {
                            await signInAnonymously(auth);
                        }
                        userId = auth.currentUser.uid;
                        document.getElementById('user-id').innerText = userId;
                    } catch (error) {
                        console.error("Error signing in:", error);
                        showModal("Authentication Error", "Failed to sign in. Please try again.");
                    }
                }
                isAuthReady = true;
                // Once auth is ready, set up Firestore listeners
                setupFirestoreListeners();
            });
        } else {
            console.error("Firebase config not found. Running in a limited mode without persistence.");
            showModal("Configuration Error", "Firebase configuration is missing. Data persistence will not work.");
            document.getElementById('user-id').innerText = "Not available (No Firebase)";
            isAuthReady = true; // Allow app to function without persistence
        }

        // Firestore Listeners
        function setupFirestoreListeners() {
            if (!db || !isAuthReady) {
                console.log("Firestore or Auth not ready, skipping listener setup.");
                return;
            }

            const roadmapDocRef = doc(db, `artifacts/${appId}/users/${userId}/roadmaps`, 'currentRoadmap');

            onSnapshot(roadmapDocRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    if (data.roadmap && data.timetable) {
                        currentRoadmapData = data.roadmap;
                        currentTimetableData = data.timetable;
                        renderRoadmap(currentRoadmapData);
                        renderTimetable(currentTimetableData);
                        calculateProgress();
                        document.getElementById('roadmap-section').style.display = 'block';
                        document.getElementById('timetable-section').style.display = 'block';
                    }
                } else {
                    console.log("No existing roadmap found for this user.");
                    document.getElementById('roadmap-section').style.display = 'none';
                    document.getElementById('timetable-section').style.display = 'none';
                }
            }, (error) => {
                console.error("Error listening to roadmap changes:", error);
                showModal("Data Error", "Failed to load your roadmap. Please try generating it again.");
            });
        }

        // Show/Hide Loading Overlay
        function showLoading(message = "Generating your personalized plan...") {
            document.getElementById('loading-overlay').classList.remove('hidden');
            document.getElementById('loading-overlay').querySelector('p').innerText = message;
        }

        function hideLoading() {
            document.getElementById('loading-overlay').classList.add('hidden');
        }

        // Render Roadmap
        function renderRoadmap(roadmap) {
            const roadmapOutput = document.getElementById('roadmap-output');
            roadmapOutput.innerHTML = '';
            if (roadmap.length === 0) {
                roadmapOutput.innerHTML = '<p class="text-center text-gray-500">No roadmap generated yet. Try again!</p>';
                return;
            }
            roadmap.forEach((module, index) => {
                const moduleElement = document.createElement('div');
                moduleElement.classList.add('roadmap-item', 'mb-4', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                moduleElement.innerHTML = `
                    <div class="flex items-center justify-between mb-2">
                        <h3 class="text-xl font-semibold text-indigo-700">${index + 1}. ${module.title}</h3>
                        <label class="flex items-center space-x-2 cursor-pointer">
                            <input type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                data-module-title="${module.title}" ${module.completed ? 'checked' : ''}>
                            <span class="text-sm text-gray-700">Completed</span>
                        </label>
                    </div>
                    <p class="text-gray-700 mb-2">${module.description}</p>
                    <div class="flex items-center text-sm text-gray-600">
                        <span class="mr-4">Estimated: <span class="font-medium">${module.estimatedHours} hours</span></span>
                        <span class="px-3 py-1 rounded-full text-xs font-semibold ${getDifficultyClass(module.difficulty)}">
                            ${module.difficulty}
                        </span>
                    </div>
                    ${module.resources && module.resources.length > 0 ? `
                        <div class="mt-3">
                            <h4 class="text-sm font-semibold text-gray-700">Resources:</h4>
                            <ul class="list-disc list-inside text-sm text-gray-600">
                                ${module.resources.map(res => `<li><a href="${res.url}" target="_blank" class="text-indigo-500 hover:underline">${res.title}</a></li>`).join('')}
                            </ul>
                        </div>
                    ` : ''}
                `;
                roadmapOutput.appendChild(moduleElement);

                // Add event listener for completion checkbox
                const checkbox = moduleElement.querySelector('input[type="checkbox"]');
                if (checkbox) {
                    checkbox.addEventListener('change', async (e) => {
                        const moduleTitle = e.target.dataset.moduleTitle;
                        const isCompleted = e.target.checked;
                        await updateModuleCompletion(moduleTitle, isCompleted);
                    });
                }
            });
        }

        function getDifficultyClass(difficulty) {
            switch (difficulty.toLowerCase()) {
                case 'easy': return 'difficulty-easy';
                case 'medium': return 'difficulty-medium';
                case 'hard': return 'difficulty-hard';
                default: return 'bg-gray-200 text-gray-700';
            }
        }

        // Update module completion status in Firestore
        async function updateModuleCompletion(moduleTitle, isCompleted) {
            if (!db || !isAuthReady) {
                showModal("Error", "Firebase not initialized. Cannot save progress.");
                return;
            }

            // Find the module in the current roadmap data
            const moduleIndex = currentRoadmapData.findIndex(m => m.title === moduleTitle);
            if (moduleIndex !== -1) {
                currentRoadmapData[moduleIndex].completed = isCompleted;

                // Also update completion status in timetable if present
                for (const date in currentTimetableData) {
                    currentTimetableData[date] = currentTimetableData[date].map(item => {
                        if (item.title === moduleTitle) {
                            return { ...item, completed: isCompleted };
                        }
                        return item;
                    });
                }

                const roadmapDocRef = doc(db, `artifacts/${appId}/users/${userId}/roadmaps`, 'currentRoadmap');
                try {
                    await setDoc(roadmapDocRef, {
                        roadmap: currentRoadmapData,
                        timetable: currentTimetableData,
                        // Preserve other fields
                        topic: document.getElementById('topic').value,
                        deadline: document.getElementById('deadline').value,
                        hoursPerDay: parseInt(document.getElementById('hoursPerDay').value),
                        skillLevel: document.getElementById('skillLevel').value,
                        generatedAt: new Date().toISOString()
                    }, { merge: true }); // Use merge to only update specified fields
                    console.log(`Module '${moduleTitle}' completion updated to ${isCompleted}.`);
                    calculateProgress(); // Recalculate progress after update
                } catch (error) {
                    console.error("Error updating module completion:", error);
                    showModal("Save Error", "Failed to update module completion. Please try again.");
                }
            }
        }

        // Calculate and display progress
        function calculateProgress() {
            if (currentRoadmapData.length === 0) {
                document.getElementById('progress-bar').style.width = '0%';
                document.getElementById('progress-text').innerText = '0% completed';
                return;
            }
            const completedModules = currentRoadmapData.filter(module => module.completed).length;
            const totalModules = currentRoadmapData.length;
            const progressPercentage = (completedModules / totalModules) * 100;
            document.getElementById('progress-bar').style.width = `${progressPercentage}%`;
            document.getElementById('progress-text').innerText = `${progressPercentage.toFixed(0)}% completed (${completedModules}/${totalModules} modules)`;
        }

        let draggedItem = null;
        let draggedItemOriginalDate = null;

        // Render Timetable
        function renderTimetable(timetable) {
            const timetableOutput = document.getElementById('timetable-output');
            timetableOutput.innerHTML = '';
            if (Object.keys(timetable).length === 0) {
                timetableOutput.innerHTML = '<p class="text-center text-gray-500">No timetable generated yet. Try again!</p>';
                return;
            }

            for (const date in timetable) {
                const dayPlan = timetable[date];
                const dayElement = document.createElement('div');
                dayElement.classList.add('timetable-day', 'mb-4', 'p-4', 'rounded-lg', 'shadow-sm', 'border', 'border-gray-200');
                dayElement.innerHTML = `
                    <h3 class="text-xl font-semibold text-indigo-700 mb-3">${new Date(date).toLocaleDateString('en-US', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}</h3>
                    <ul class="list-disc pl-5 min-h-[50px] space-y-2" data-date="${date}">
                        ${dayPlan.map((item, index) => `
                            <li draggable="true" data-module-id="${item.moduleId}" data-original-date="${date}" data-index="${index}"
                                class="flex items-center justify-between p-2 bg-white rounded-md shadow-sm border border-gray-100 cursor-grab">
                                <span class="text-gray-700 ${item.completed ? 'line-through text-gray-500' : ''}">${item.title} (${item.hours} hours)</span>
                                <input type="checkbox" class="h-4 w-4 text-indigo-600 focus:ring-indigo-500 border-gray-300 rounded"
                                    data-module-title="${item.title}" ${item.completed ? 'checked' : ''}>
                            </li>
                        `).join('')}
                    </ul>
                `;
                timetableOutput.appendChild(dayElement);

                // Add event listeners for completion checkboxes within timetable
                dayElement.querySelectorAll('input[type="checkbox"]').forEach(checkbox => {
                    checkbox.addEventListener('change', async (e) => {
                        const moduleTitle = e.target.dataset.moduleTitle;
                        const isCompleted = e.target.checked;
                        await updateModuleCompletion(moduleTitle, isCompleted);
                    });
                });

                // Add drag and drop listeners for the ul (day container)
                const ul = dayElement.querySelector('ul');
                ul.addEventListener('dragover', (e) => {
                    e.preventDefault(); // Allow drop
                    ul.classList.add('drop-target');
                });
                ul.addEventListener('dragleave', () => {
                    ul.classList.remove('drop-target');
                });
                ul.addEventListener('drop', async (e) => {
                    e.preventDefault();
                    ul.classList.remove('drop-target');

                    if (!draggedItem) return;

                    const targetDate = ul.dataset.date;
                    const originalDate = draggedItemOriginalDate;
                    const draggedModuleId = draggedItem.dataset.moduleId;

                    // Find the module object from the original day's data
                    const moduleToMove = currentTimetableData[originalDate].find(item => item.moduleId === draggedModuleId);

                    if (!moduleToMove) return;

                    // Remove from original day
                    currentTimetableData[originalDate] = currentTimetableData[originalDate].filter(item => item.moduleId !== draggedModuleId);

                    // Add to target day, maintaining order if dropping onto another item
                    const afterElement = getDragAfterElement(ul, e.clientY);
                    if (afterElement == null) {
                        currentTimetableData[targetDate].push(moduleToMove);
                    } else {
                        const targetIndex = Array.from(ul.children).indexOf(afterElement);
                        currentTimetableData[targetDate].splice(targetIndex, 0, moduleToMove);
                    }

                    // Save updated timetable to Firestore
                    await saveTimetableToFirestore();

                    draggedItem = null;
                    draggedItemOriginalDate = null;
                });
            }

            // Add dragstart listener to each draggable li
            timetableOutput.querySelectorAll('li[draggable="true"]').forEach(li => {
                li.addEventListener('dragstart', (e) => {
                    draggedItem = li;
                    draggedItemOriginalDate = li.dataset.originalDate;
                    e.dataTransfer.effectAllowed = 'move';
                    e.dataTransfer.setData('text/plain', li.dataset.moduleId); // Store module ID
                    setTimeout(() => {
                        li.classList.add('dragging');
                    }, 0);
                });

                li.addEventListener('dragend', () => {
                    draggedItem.classList.remove('dragging');
                    draggedItem = null;
                    draggedItemOriginalDate = null;
                });
            });
        }

        // Helper for drag-and-drop to find where to insert
        function getDragAfterElement(container, y) {
            const draggableElements = [...container.querySelectorAll('li:not(.dragging)')];
            return draggableElements.reduce((closest, child) => {
                const box = child.getBoundingClientRect();
                const offset = y - box.top - box.height / 2;
                if (offset < 0 && offset > closest.offset) {
                    return { offset: offset, element: child };
                } else {
                    return closest;
                }
            }, { offset: -Number.POSITIVE_INFINITY }).element;
        }

        // Save current timetable to Firestore
        async function saveTimetableToFirestore() {
            if (!db || !isAuthReady) {
                showModal("Error", "Firebase not initialized. Cannot save timetable.");
                return;
            }
            const roadmapDocRef = doc(db, `artifacts/${appId}/users/${userId}/roadmaps`, 'currentRoadmap');
            try {
                await setDoc(roadmapDocRef, {
                    timetable: currentTimetableData,
                    // Preserve other fields
                    topic: document.getElementById('topic').value,
                    deadline: document.getElementById('deadline').value,
                    hoursPerDay: parseInt(document.getElementById('hoursPerDay').value),
                    skillLevel: document.getElementById('skillLevel').value,
                    roadmap: currentRoadmapData,
                    generatedAt: new Date().toISOString()
                }, { merge: true });
                console.log("Timetable updated in Firestore.");
            } catch (error) {
                console.error("Error saving timetable:", error);
                showModal("Save Error", "Failed to save timetable changes. Please try again.");
            }
        }


        // Generate Roadmap & Timetable
        document.getElementById('generate-btn').addEventListener('click', async () => {
            const topic = document.getElementById('topic').value.trim();
            const deadline = document.getElementById('deadline').value;
            const hoursPerDay = parseInt(document.getElementById('hoursPerDay').value);
            const skillLevel = document.getElementById('skillLevel').value;
            const excludeWeekends = document.getElementById('excludeWeekends').checked;

            if (!topic || !deadline || !hoursPerDay) {
                showModal("Input Error", "Please fill in all the required fields: Topic, Deadline, and Hours per Day.");
                return;
            }

            if (isNaN(hoursPerDay) || hoursPerDay <= 0 || hoursPerDay > 24) {
                showModal("Input Error", "Hours per Day must be a positive number between 1 and 24.");
                return;
            }

            const today = new Date();
            today.setHours(0, 0, 0, 0); // Normalize today's date
            const deadlineDate = new Date(deadline);
            deadlineDate.setHours(0, 0, 0, 0); // Normalize deadline date

            if (deadlineDate < today) {
                showModal("Input Error", "The deadline cannot be in the past. Please select a future date.");
                return;
            }

            showLoading();

            try {
                // Step 1: Generate Roadmap using Gemini API
                const prompt = `Generate a personalized learning roadmap and estimated timetable for a user who wants to learn '${topic}'.
                The user is a '${skillLevel}' and wants to complete this by '${deadline}' studying '${hoursPerDay}' hours per day.
                Provide the output as a JSON array of objects, where each object represents a module/topic.
                Each module object should have the following properties:
                - \`title\`: (string) The title of the module.
                - \`description\`: (string) A brief description of the module.
                - \`estimatedHours\`: (number) Estimated hours to complete this module. This should be a reasonable number for learning.
                - \`difficulty\`: (string) 'Easy', 'Medium', or 'Hard'.
                - \`prerequisites\`: (array of strings) Any modules that should be completed before this one (use module titles).
                - \`resources\`: (array of objects) A list of relevant learning resources for this module. Each resource object should have:
                    - \`title\`: (string) The title of the resource (e.g., "Official React Docs", "Eloquent JavaScript").
                    - \`url\`: (string) The URL to the resource.
                Ensure the roadmap is logical and progressive. Do not include any conversational text outside the JSON.
                The total estimated hours across all modules should be realistic for the given deadline and daily study hours.`;

                let chatHistory = [];
                chatHistory.push({ role: "user", parts: [{ text: prompt }] });

                const payload = {
                    contents: chatHistory,
                    generationConfig: {
                        responseMimeType: "application/json",
                        responseSchema: {
                            type: "ARRAY",
                            items: {
                                type: "OBJECT",
                                properties: {
                                    "title": { "type": "STRING" },
                                    "description": { "type": "STRING" },
                                    "estimatedHours": { "type": "NUMBER" },
                                    "difficulty": { "type": "STRING", "enum": ["Easy", "Medium", "Hard"] },
                                    "prerequisites": { "type": "ARRAY", "items": { "type": "STRING" } },
                                    "resources": {
                                        "type": "ARRAY",
                                        "items": {
                                            "type": "OBJECT",
                                            "properties": {
                                                "title": { "type": "STRING" },
                                                "url": { "type": "STRING" }
                                            },
                                            "required": ["title", "url"]
                                        }
                                    }
                                },
                                "required": ["title", "description", "estimatedHours", "difficulty", "prerequisites", "resources"]
                            }
                        }
                    }
                };

                const apiKey = ""; // Canvas will automatically provide the API key
                const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent?key=${apiKey}`;

                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                const result = await response.json();

                let roadmap = [];
                if (result.candidates && result.candidates.length > 0 &&
                    result.candidates[0].content && result.candidates[0].content.parts &&
                    result.candidates[0].content.parts.length > 0) {
                    const jsonText = result.candidates[0].content.parts[0].text;
                    try {
                        roadmap = JSON.parse(jsonText);
                        if (!Array.isArray(roadmap)) {
                            throw new Error("AI response is not a JSON array.");
                        }
                        // Initialize 'completed' status for new modules
                        roadmap = roadmap.map(module => ({ ...module, completed: false }));
                    } catch (parseError) {
                        console.error("Failed to parse AI response JSON:", parseError);
                        showModal("AI Response Error", "Could not understand the AI's response. Please try again.");
                        hideLoading();
                        return;
                    }
                } else {
                    showModal("AI Generation Failed", "The AI could not generate a roadmap. Please try again with a different topic or adjust parameters.");
                    hideLoading();
                    return;
                }

                // Step 2: Generate Timetable
                const timetable = generateTimetable(roadmap, deadlineDate, hoursPerDay, excludeWeekends);

                // Step 3: Save to Firestore
                if (db && isAuthReady) {
                    const roadmapDocRef = doc(db, `artifacts/${appId}/users/${userId}/roadmaps`, 'currentRoadmap');
                    await setDoc(roadmapDocRef, {
                        topic: topic,
                        deadline: deadline,
                        hoursPerDay: hoursPerDay,
                        skillLevel: skillLevel,
                        excludeWeekends: excludeWeekends,
                        roadmap: roadmap,
                        timetable: timetable,
                        generatedAt: new Date().toISOString()
                    });
                    console.log("Roadmap and timetable saved to Firestore.");
                } else {
                    // If Firestore is not available, just render
                    currentRoadmapData = roadmap;
                    currentTimetableData = timetable;
                    renderRoadmap(roadmap);
                    renderTimetable(timetable);
                    calculateProgress();
                    document.getElementById('roadmap-section').style.display = 'block';
                    document.getElementById('timetable-section').style.display = 'block';
                    showModal("Success!", "Roadmap and timetable generated. (Not saved as Firebase is not configured)");
                }

            } catch (error) {
                console.error("Error generating roadmap or timetable:", error);
                showModal("Generation Error", `An error occurred: ${error.message}. Please check your inputs and try again.`);
            } finally {
                hideLoading();
            }
        });

        // Timetable Generation Logic
        function generateTimetable(roadmap, deadlineDate, hoursPerDay, excludeWeekends) {
            const timetable = {};
            let currentDate = new Date();
            currentDate.setHours(0, 0, 0, 0); // Start from today

            // Sort roadmap by prerequisites (simple topological sort for MVP)
            const sortedRoadmap = [];
            const completedModules = new Set();
            let modulesToProcess = [...roadmap];

            while (modulesToProcess.length > 0) {
                let foundModuleThisIteration = false;
                for (let i = 0; i < modulesToProcess.length; i++) {
                    const module = modulesToProcess[i];
                    // Check if all prerequisites are either completed or not in the remaining modules to process
                    const allPrereqsMet = module.prerequisites.every(prereq =>
                        completedModules.has(prereq) || !modulesToProcess.some(m => m.title === prereq)
                    );

                    if (allPrereqsMet) {
                        sortedRoadmap.push(module);
                        completedModules.add(module.title);
                        modulesToProcess.splice(i, 1); // Remove from modules to process
                        foundModuleThisIteration = true;
                        break; // Restart loop to check for new available modules
                    }
                }
                if (!foundModuleThisIteration && modulesToProcess.length > 0) {
                    // This indicates a circular dependency or an unresolvable prerequisite among remaining modules.
                    // For MVP, we'll just add remaining modules without strict order.
                    console.warn("Circular dependency or unresolvable prerequisites detected. Adding remaining modules without strict order.");
                    sortedRoadmap.push(...modulesToProcess);
                    modulesToProcess = [];
                }
            }


            let remainingHoursToday = hoursPerDay;
            let currentModuleIndex = 0;

            while (currentModuleIndex < sortedRoadmap.length && currentDate <= deadlineDate) {
                // Skip weekends if excludeWeekends is true
                if (excludeWeekends && (currentDate.getDay() === 0 || currentDate.getDay() === 6)) { // 0 = Sunday, 6 = Saturday
                    currentDate.setDate(currentDate.getDate() + 1);
                    currentDate.setHours(0, 0, 0, 0);
                    continue; // Skip to the next day
                }

                const module = sortedRoadmap[currentModuleIndex];
                let moduleRemainingHours = module.estimatedHours;

                while (moduleRemainingHours > 0 && currentDate <= deadlineDate) {
                    const dateString = currentDate.toISOString().split('T')[0];
                    if (!timetable[dateString]) {
                        timetable[dateString] = [];
                        remainingHoursToday = hoursPerDay;
                    }

                    const hoursToAssign = Math.min(moduleRemainingHours, remainingHoursToday);

                    if (hoursToAssign > 0) {
                        timetable[dateString].push({
                            title: module.title,
                            hours: hoursToAssign,
                            moduleId: module.title, // Simple ID for now
                            completed: module.completed || false // Inherit completion status
                        });
                        moduleRemainingHours -= hoursToAssign;
                        remainingHoursToday -= hoursToAssign;
                    }

                    if (moduleRemainingHours === 0) {
                        currentModuleIndex++; // Move to next module
                    }

                    if (remainingHoursToday === 0 || moduleRemainingHours > 0) {
                        // Move to next day if daily hours are used up or module still has hours
                        currentDate.setDate(currentDate.getDate() + 1);
                        currentDate.setHours(0, 0, 0, 0);
                        remainingHoursToday = hoursPerDay; // Reset daily hours

                        // Skip weekends for the next day if excludeWeekends is true
                        while (excludeWeekends && (currentDate.getDay() === 0 || currentDate.getDay() === 6)) {
                            currentDate.setDate(currentDate.getDate() + 1);
                            currentDate.setHours(0, 0, 0, 0);
                        }
                    }
                }
            }

            // If some modules couldn't be scheduled within the deadline
            if (currentModuleIndex < sortedRoadmap.length) {
                console.warn("Some modules could not be scheduled within the given deadline.");
                showModal("Warning", "Some modules could not be scheduled within the given deadline. You might need more time or study hours.");
            }

            return timetable;
        }

        // Notification functionality
        document.getElementById('enable-notifications-btn').addEventListener('click', async () => {
            if (!("Notification" in window)) {
                showModal("Notifications Not Supported", "This browser does not support desktop notifications.");
                return;
            }

            const permission = await Notification.requestPermission();
            if (permission === "granted") {
                showModal("Notifications Enabled", "You will receive daily reminders if you enable them in your browser settings.");
                // For a real app, you'd schedule daily notifications here based on timetable
                // For MVP, just a test notification
                new Notification("Roadmap Reminder", {
                    body: "Your study plan is ready! Time to learn something new.",
                    icon: "https://placehold.co/48x48/6366f1/ffffff?text=AI"
                });
            } else if (permission === "denied") {
                showModal("Notifications Denied", "You have blocked notifications. Please enable them in your browser settings to receive reminders.");
            } else {
                showModal("Notifications Blocked", "Notification permission was not granted.");
            }
        });


        // Initial setup on load
        window.onload = function() {
            // Set default deadline to 3 months from now
            const defaultDeadline = new Date();
            defaultDeadline.setMonth(defaultDeadline.getMonth() + 3);
            document.getElementById('deadline').value = defaultDeadline.toISOString().split('T')[0];
        };

    </script>
</body>
</html>
